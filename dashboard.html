<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | Asesores</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --azul: #003366; --dorado: #C5A059; --gris: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gris); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .saldo-card { background: var(--azul); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center; }
        .saldo-monto { font-size: 2.5rem; font-weight: bold; color: var(--dorado); }
        .form-carga { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-enviar { background: #28a745; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-logout { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="font-weight: bold; color: var(--azul);">DPR Consultoría</div>
        <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
    </div>

    <div class="saldo-card">
        <div>Tu Saldo Prepago Disponible</div>
        <div class="saldo-monto" id="saldo-display">$0.00</div>
        <div id="user-email" style="font-size: 0.8rem; opacity: 0.8;">Cargando usuario...</div>
    </div>

    <div class="form-carga">
        <h3>Notificar Depósito / Transferencia</h3>
        <p style="font-size: 0.85rem; color: #666;">Ingresa los datos de tu transferencia para validar y abonar a tu saldo.</p>
        
        <label>Monto Depositado ($)</label>
        <input type="number" id="monto" placeholder="Ej: 500">
        
        <label>Clave de Rastreo (CEP / Referencia)</label>
        <input type="text" id="rastreo" placeholder="Número de 20 a 30 dígitos">
        
        <button class="btn-enviar" onclick="enviarReporte()">Enviar para Validación</button>
        <div id="status-pago" style="margin-top: 10px; font-weight: bold; text-align: center;"></div>
    </div>
</div>

<script>
    // Configuración de tu Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAEDygVfkQbJgMuEmm_We-OlQFTKzQ1raM",
      authDomain: "pensionsegura-9c817.firebaseapp.com",
      projectId: "pensionsegura-9c817",
      storageBucket: "pensionsegura-9c817.firebasestorage.app",
      messagingSenderId: "169500313261",
      appId: "1:169500313261:web:15e2b662571df505d36824"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 1. Proteger la ruta: Ver si hay usuario
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('user-email').innerText = user.email;
            cargarSaldo(user.uid);
        } else {
            window.location.href = "login.html";
        }
    });

    // 2. Cargar saldo desde Firestore
    function cargarSaldo(uid) {
        db.collection("asesores").doc(uid).onSnapshot((doc) => {
            if (doc.exists) {
                document.getElementById('saldo-display').innerText = "$" + doc.data().saldo.toFixed(2);
            } else {
                // Si no tiene ficha, crear una inicial en $0
                db.collection("asesores").doc(uid).set({ saldo: 0, email: auth.currentUser.email });
            }
        });
    }

    // 3. Función para enviar el reporte de pago
    function enviarReporte() {
        const monto = document.getElementById('monto').value;
        const rastreo = document.getElementById('rastreo').value;
        const status = document.getElementById('status-pago');

        if(!monto || !rastreo) {
            alert("Por favor llena todos los campos");
            return;
        }

        // Guardamos la notificación para que TÚ la veas en Firebase
        db.collection("notificaciones_pago").add({
            email: auth.currentUser.email,
            uid: auth.currentUser.uid,
            monto: parseFloat(monto),
            rastreo: rastreo,
            fecha: firebase.firestore.FieldValue.serverTimestamp(),
            estatus: "pendiente"
        }).then(() => {
            status.style.color = "orange";
            status.innerText = "¡Reporte enviado! En espera de validación.";
            document.getElementById('monto').value = "";
            document.getElementById('rastreo').value = "";
        });
    }

    function logout() {
        auth.signOut();
    }
</script>

</body>
</html>
