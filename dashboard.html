<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPR Consultor√≠a | Panel Ejecutivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; scroll-behavior: smooth; }
        .gold-gradient { background: linear-gradient(135deg, #C5A059 0%, #F1D299 50%, #B88A44 100%); }
        .category-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; cursor: pointer; }
        .category-card:hover { border-color: #C5A059; background: rgba(255, 255, 255, 0.07); }
        .input-dark { background: #1E293B; border: 1px solid #334155; color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; }
        .input-dark:focus { border-color: #C5A059; }
        .gold-text { color: #C5A059; }
        .status-badge { padding: 4px 10px; border-radius: 9999px; font-size: 9px; font-weight: 900; text-transform: uppercase; }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-marquee {
            display: inline-flex;
            animation: marquee 25s linear infinite;
        }
        .animate-marquee:hover {
            animation-play-state: paused;
        }
    </style>
</head>
<body>

    <div class="bg-yellow-400 py-2 overflow-hidden border-b border-yellow-600 shadow-lg">
        <div class="whitespace-nowrap animate-marquee flex items-center">
            <span class="text-slate-900 font-black uppercase italic text-xs mx-4">
                ‚ö†Ô∏èSEMANAS COTIZADAS SALIENDO CORRECTAMENTE . √öNETE A NUESTRO CANAL DE AVISOS! . ‚ö†Ô∏è
            </span>
            <span class="text-slate-900 font-black uppercase italic text-xs mx-4">
                ‚ö†Ô∏èRECUERDA QUE LA RECARGA MINIMA ES DE $200, NO SE HACEN DEVOLUCIONES EN RECARGAS MENORES YA QUE EL SISTEMA ES AUTOMATIZADO . ‚ö†Ô∏è
            </span>
            <span class="text-slate-900 font-black uppercase italic text-xs mx-4">
                ‚ö†Ô∏èTARJETA NSS SALIENDO CORRECTAMENTE . √öNETE A NUESTRO CANAL DE AVISOS! . ‚ö†Ô∏è
            </span>
        </div>
    </div>

    <header class="sticky top-0 z-40 bg-slate-900/90 border-b border-slate-800 backdrop-blur-md">
        <div class="max-w-7xl mx-auto p-5 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="gold-gradient w-10 h-10 rounded-xl flex items-center justify-center font-black text-slate-900">DP</div>
                <h1 class="font-black uppercase tracking-tighter text-xl text-white">DPR <span class="gold-text italic">Consultor√≠a</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="abrirModal('modalSaldo')" class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 flex items-center gap-2 hover:bg-slate-700 transition">
                    <span id="txtSaldoHeader" class="font-black text-white">...</span>
                </button>
                <button onclick="window.cerrarSesion()" class="text-[10px] font-black uppercase text-red-500 tracking-widest">Salir</button>
            </div>
        </div>
    </header>

    <a href="https://whatsapp.com/channel/0029Vb6qdE98qIzsQVAeeU3e" target="_blank" 
       class="fixed bottom-6 right-6 z-50 bg-[#25D366] text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform flex items-center gap-2 group">
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-500 whitespace-nowrap font-black uppercase text-[10px] tracking-widest">
            √önete al Canal de Avisos
        </span>
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.246 2.248 3.484 5.232 3.484 8.412-.003 6.557-5.338 11.892-11.893 11.892-1.997-.001-3.951-.5-5.688-1.448l-6.309 1.656zm6.224-3.92l.356.211c1.639.973 3.532 1.488 5.467 1.489 5.811 0 10.537-4.729 10.54-10.539 0-2.817-1.097-5.465-3.091-7.46s-4.644-3.091-7.463-3.091c-5.815 0-10.542 4.729-10.545 10.539 0 2.115.556 4.177 1.61 5.976l.233.396-1.06 3.869 3.967-1.041z"/></svg>
    </a>

    <main class="p-6 max-w-7xl mx-auto">
        <h2 class="text-sm font-black uppercase tracking-[0.3em] text-slate-500 mb-6 text-center md:text-left">Servicios Disponibles</h2>
        
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-12">
            <button onclick="mostrarTramites('IMSS')" class="category-card p-4 rounded-2xl text-center">
                <span class="text-2xl block mb-2">üè•</span>
                <span class="text-[10px] font-black uppercase tracking-tighter">IMSS</span>
            </button>
            <button onclick="mostrarTramites('SAT')" class="category-card p-4 rounded-2xl text-center">
                <span class="text-2xl block mb-2">‚öñÔ∏è</span>
                <span class="text-[10px] font-black uppercase tracking-tighter">SAT</span>
            </button>
            <button onclick="window.open('herramientas.html', '_blank')" class="category-card p-4 rounded-2xl text-center">
                <span class="text-2xl block mb-2">üßÆ</span>
                <span class="text-[10px] font-black uppercase tracking-tighter">CALCULADORAS</span>
            </button>
            <button onclick="mostrarTramites('DOC')" class="category-card p-4 rounded-2xl text-center">
                <span class="text-2xl block mb-2">üìÑ</span>
                <span class="text-[10px] font-black uppercase tracking-tighter">DOCUMENTOS</span>
            </button>
            <button onclick="mostrarTramites('INF')" class="category-card p-4 rounded-2xl text-center">
                <span class="text-2xl block mb-2">üè†</span>
                <span class="text-[10px] font-black uppercase tracking-tighter">INFONAVIT</span>
            </button>
            <button onclick="window.mostrarSeccionAfore()" class="category-card p-4 rounded-2xl text-center border-blue-500/40">
                <span class="text-2xl block mb-2">üí∞</span>
                <span class="text-[10px] font-black uppercase tracking-tighter text-blue-400 font-bold">ESTADOS CUENTA</span>
            </button>
        </div>

        <div id="seccionAfore" class="hidden bg-slate-800/40 p-8 rounded-[2.5rem] border border-blue-500/20 mb-12 animate-fade">
            <h2 class="text-xl font-black uppercase mb-6 italic border-l-4 border-blue-600 pl-4 gold-text">Estado de Cuenta Afore</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="text-[10px] uppercase text-slate-500 font-black ml-2">Administradora</label>
                    <select id="selectAfore" onchange="window.actualizarPrecioAfore()" class="input-dark text-sm font-bold mt-1">
                        <option value="">-- Seleccionar Afore --</option>
                        <option value="Sura">Sura ($750)</option>
                        <option value="Invercap">Invercap ($1400)</option>
                        <option value="Profuturo">Profuturo ($500)</option>
                        <option value="Banorte">Banorte ($600)</option>
                        <option value="Coppel">Coppel ($350)</option>
                        <option value="Azteca">Azteca ($350)</option>
                        <option value="Principal">Principal ($750)</option>
                        <option value="Banamex">Banamex ($1200)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="nssAfore" maxlength="11" placeholder="NSS (11 D√çGITOS)" class="input-dark font-black">
                    <input type="text" id="curpAfore" placeholder="CURP" class="input-dark uppercase font-black">
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-white/5 flex justify-between items-center">
                <div><p class="text-[10px] text-slate-500 uppercase">Costo</p><p id="txtPrecioAfore" class="text-3xl font-black gold-text">$0.00</p></div>
                <button onclick="window.pagarEstadoCuenta()" class="bg-white text-slate-900 px-10 py-4 rounded-2xl font-black uppercase italic shadow-xl hover:scale-105 transition">Confirmar Pago</button>
            </div>
        </div>

        <div id="listaServicios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-12 hidden animate-fade"></div>

        <section class="bg-slate-900/50 rounded-[2.5rem] border border-slate-800 p-6 shadow-2xl">
            <h2 class="text-xl font-black text-white uppercase italic mb-6">Mis Solicitudes Recientes</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[10px] font-black uppercase text-slate-500 border-b border-slate-800">
                            <th class="pb-4 px-2">Fecha</th>
                            <th class="pb-4 px-2">Servicio</th>
                            <th class="pb-4 px-2 text-center">Estatus</th>
                            <th class="pb-4 px-2 text-right">Documento</th>
                        </tr>
                    </thead>
                    <tbody id="listaHistorial" class="text-xs"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modalTramite" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-lg rounded-[3rem] p-8 border border-slate-800 shadow-2xl overflow-y-auto max-h-[90vh]">
            <button onclick="cerrarModal()" class="absolute top-6 right-8 text-slate-500 text-2xl">√ó</button>
            <div id="formContent"></div>
        </div>
    </div>

    <div id="modalSaldo" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-[3rem] p-10 relative border border-slate-800 shadow-2xl text-center">
            <button onclick="cerrarModal()" class="absolute top-6 right-8 text-slate-500 text-2xl">√ó</button>
            <h2 class="text-xl font-black text-white uppercase mb-6 tracking-tighter">Recargar Saldo</h2>
            <div class="bg-blue-600/10 border-2 border-blue-500/30 p-6 rounded-[2rem] mb-8">
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2 italic">Datos para transferencia</p>
                <p class="text-2xl font-black text-white tracking-widest mb-1">4915 6630 4036 4896</p>
                <p class="text-xs font-bold text-white uppercase opacity-80">Banorte | Diana Puente Rodriguez</p>
            </div>
            <div class="space-y-3">
                <input type="number" id="depMonto" placeholder="Monto Recarga" class="input-dark text-center font-black">
                <input type="text" id="depRef" placeholder="Folio de rastreo" class="input-dark uppercase font-bold text-center">
                <input type="file" id="fileRecarga" class="block w-full text-[10px] text-slate-500">
                <button onclick="notificarPago()" id="btnNotificar" class="w-full gold-gradient py-4 rounded-2xl font-black uppercase text-slate-900 shadow-lg mt-4">Informar Pago</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, addDoc, collection, query, where, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEDygVfkQbJgMuEmm_We-OlQFTKzQ1raM",
            authDomain: "pensionsegura-9c817.firebaseapp.com",
            projectId: "pensionsegura-9c817"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLOUD_NAME = "de5abnhul"; 
        const UPLOAD_PRESET = "dpr_uploads";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;

        let saldoGlobal = 0, userUID = "", emailAsesor = "";
        const PRECIOS_AFORE = { "Sura": 750, "Invercap": 1400, "Profuturo": 500, "Banorte": 600, "Coppel": 350, "Azteca": 350, "Principal": 750, "Banamex": 1200 };

        const TRAMITES = {
            'IMSS': [
                { id: 'M10', nombre: 'Modalidad 10', precio: 200, nss: true, extra: 'DIRECCI√ìN' },
                { id: 'ALTA MENSUAL', nombre: 'ALTA MENSUAL', precio: 600, nss: true, curp: true },
                { id: 'RESUMEN AFORE', nombre: 'RESUMEN AFORE', precio: 15, nss: true, curp: true },
                { id: 'RETIRO PARCIAL', nombre: 'RETIRO POR DESEMPLEO A DISTANCIA', precio: 70, nss: true, curp: true },
                { id: 'REGISTRO DIST', nombre: 'REGISTRO A DISTANCIA', precio: 300, nss: true, curp: true },
                { id: 'SINDO UR', nombre: 'SINDO ULTIMO RETIRO', precio: 40, nss: true },    
                { id: 'SINDO ALFA', nombre: 'SINDO ALFA NUMERICO', precio: 80, curp: true },
                { id: 'SINDO COMP', nombre: 'SINDO COMPLETO', precio: 220, nss: true }
            ],
            'SAT': [
                { id: 'RFC_CLON', nombre: 'RFC Clon', precio: 35, curp: true },
                { id: 'RFCV', nombre: 'RFC Verificable', precio: 140, curp: true },
                { id: 'CSF', nombre: 'Constancia Fiscal', precio: 230, curp: true },
                { id: 'RFC CON IDCIF', nombre: 'RFC CON IDCIF', precio: 40, curp: true, extra: 'IDCIF' },
                { id: 'Loc idcif', nombre: 'LOCALIZAR IDCIF', precio: 60, extra: 'DATOS ACCESO' },
                { id: 'op. cumplimiento', nombre: 'OPINION CUMPLIMIENTO', precio: 30, curp: true }
            ],
            'DOC': [
                { id: 'SC', nombre: 'Semanas Cotizadas', precio: 25, nss: true, curp: true },
                { id: 'VIGENCIA', nombre: 'Vigencia de Derechos', precio: 13, curp: true },
                { id: 'NSS', nombre: 'TARJETA NSS', precio: 13, curp: true },
                { id: 'NACIMIENTO', nombre: 'Acta de Nacimiento', precio: 15, curp: true },
                { id: 'CURP', nombre: 'CURP Certificada', precio: 4, curp: true }
            ],
            'INF': [
                { id: 'PRECA MEJVT', nombre: 'Mejoravit', precio: 120, nss: true, nac: true },
                { id: 'CUENTA', nombre: 'Crear cuenta Infonavit', precio: 150, nss: true, extra: 'TEL Y CORREO' },
                { id: 'RESET', nombre: 'Reseteo de cuenta', precio: 170, nss: true }
            ]
        };

        onAuthStateChanged(auth, (user) => {
            if (user) { userUID = user.uid; emailAsesor = user.email; escucharSaldo(); escucharHistorial(); }
            else { window.location.href = "login/index.html"; }
        });

        function escucharSaldo() {
            onSnapshot(doc(db, "asesores", userUID), (docSnap) => {
                if (docSnap.exists()) {
                    saldoGlobal = docSnap.data().saldo || 0;
                    const f = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(saldoGlobal);
                    document.getElementById('txtSaldoHeader').innerText = f;
                    document.getElementById('txtSaldoGrande').innerText = f;
                }
            });
        }

        window.mostrarSeccionAfore = () => {
            document.getElementById('seccionAfore').classList.remove('hidden');
            document.getElementById('listaServicios').classList.add('hidden');
        };

        window.actualizarPrecioAfore = () => {
            const afore = document.getElementById('selectAfore').value;
            document.getElementById('txtPrecioAfore').innerText = `$${PRECIOS_AFORE[afore] || 0}.00`;
        };

        window.pagarEstadoCuenta = async () => {
            const afore = document.getElementById('selectAfore').value;
            const nss = document.getElementById('nssAfore').value;
            const curp = document.getElementById('curpAfore').value;
            const costo = PRECIOS_AFORE[afore];
            if (!afore || nss.length < 11 || curp.length < 10) return alert("Datos incompletos.");
            if (saldoGlobal < costo) return alert("Saldo insuficiente.");
            if (confirm(`¬øPagar $${costo}?`)) {
                await updateDoc(doc(db, "asesores", userUID), { saldo: increment(-costo) });
                await addDoc(collection(db, "solicitudes"), {
                    asesor_uid: userUID, origen: "ASESOR", nombre: emailAsesor,
                    tipo: `ECTA: ${afore}`, curp: curp.toUpperCase(), nss, costo, estatus: "En Proceso", fecha: serverTimestamp()
                });
                alert("Enviado."); document.getElementById('seccionAfore').classList.add('hidden');
            }
        };

        window.mostrarTramites = (cat) => {
            document.getElementById('seccionAfore').classList.add('hidden');
            const listado = document.getElementById('listaServicios');
            listado.classList.remove('hidden');
            let html = '';
            TRAMITES[cat].forEach(t => {
                html += `<div onclick="window.prepararTramite('${t.nombre}', ${t.precio}, '${t.id}', ${t.nss || false}, ${t.nac || false}, '${t.extra || ''}')" class="category-card p-5 rounded-2xl border border-slate-700 cursor-pointer transition-all">
                    <p class="font-black text-xs uppercase text-white">${t.nombre}</p>
                    <p class="gold-text font-black text-[9px] mt-1">$${t.precio}.00</p>
                </div>`;
            });
            listado.innerHTML = html;
        };

        window.prepararTramite = (nombre, costo, pref, pideNss, pideNac, pideEx) => {
            const content = document.getElementById('formContent');
            let fields = `<input type="text" id="curp_p" placeholder="CURP" class="input-dark uppercase font-bold mb-4 w-full">`;
            if(pideNss) fields += `<input type="text" id="nss_p" placeholder="NSS (11 D√çGITOS)" class="input-dark mb-4 w-full">`;
            if(pideNac) fields += `<label class="text-[9px] ml-2 text-slate-500 uppercase font-bold">Nacimiento</label><input type="date" id="nac_p" class="input-dark mb-4 w-full">`;
            if(pideEx) fields += `<input type="text" id="extra_p" placeholder="${pideEx}" class="input-dark mb-4 w-full">`;
            content.innerHTML = `<h2 class="text-xl font-black gold-text mb-6 uppercase italic">${nombre}</h2>${fields}
                <button onclick="window.confirmarCompra('${nombre}', ${costo}, '${pref}')" class="w-full gold-gradient py-4 rounded-2xl text-slate-900 font-black uppercase shadow-xl">Confirmar y Pagar $${costo}</button>`;
            abrirModal('modalTramite');
        };

        window.confirmarCompra = async (n, c, p) => {
            if (saldoGlobal < c) return alert("Saldo insuficiente.");
            const curp = document.getElementById('curp_p').value;
            if(!curp) return alert("Ingresa la CURP.");
            await updateDoc(doc(db, "asesores", userUID), { saldo: increment(-c) });
            await addDoc(collection(db, "solicitudes"), {
                asesor_uid: userUID, origen: "ASESOR", nombre: emailAsesor,
                tipo: n, costo: c, folio: p + "-" + Math.floor(Math.random()*9000), curp: curp.toUpperCase(),
                nss: document.getElementById('nss_p')?.value || "N/A", estatus: "En Proceso", fecha: serverTimestamp()
            });
            alert("Enviado con √©xito."); cerrarModal();
        };

        function escucharHistorial() {
            const q = query(collection(db, "solicitudes"), where("asesor_uid", "==", userUID));
            onSnapshot(q, (snap) => {
                const lista = document.getElementById('listaHistorial');
                if (snap.empty) { lista.innerHTML = '<tr><td colspan="4" class="py-10 text-center text-slate-500 font-bold uppercase tracking-widest">Sin solicitudes</td></tr>'; return; }
                let solicitudes = [];
                snap.forEach(docSnap => solicitudes.push(docSnap.data()));
                solicitudes.sort((a, b) => (b.fecha?.toMillis() || 0) - (a.fecha?.toMillis() || 0));
                lista.innerHTML = "";
                solicitudes.forEach(d => {
                    let color = d.estatus === 'Terminado' ? "bg-green-500/10 text-green-500" : (d.estatus === 'Error' ? "bg-red-500/10 text-red-500" : "bg-yellow-500/10 text-yellow-500");
                    lista.innerHTML += `<tr class="border-b border-slate-800/50 hover:bg-white/5 transition">
                        <td class="py-4 px-2 text-slate-500 font-bold">${d.fecha?.toDate().toLocaleDateString() || '...'}</td>
                        <td class="py-4 px-2 font-black text-white uppercase">${d.tipo}</td>
                        <td class="py-4 px-2 text-center"><span class="status-badge ${color}">${d.estatus}</span></td>
                        <td class="py-4 px-2 text-right">${d.archivoFinal ? `<a href="${d.archivoFinal}" target="_blank" class="gold-text font-black underline">DESCARGA</a>` : '--'}</td>
                    </tr>`;
                });
            });
        }

        window.notificarPago = async () => {
            const m = parseFloat(document.getElementById('depMonto').value);
            const r = document.getElementById('depRef').value;
            const f = document.getElementById('fileRecarga').files[0];
            if (!m || !r || !f) return alert("Faltan datos.");
            const fd = new FormData(); fd.append('file', f); fd.append('upload_preset', UPLOAD_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
            const data = await res.json();
            await addDoc(collection(db, "notificaciones_pago"), { uid: userUID, asesorEmail: emailAsesor, monto: m, rastreo: r, comprobante: data.secure_url, fecha: serverTimestamp(), estatus: "pendiente" });
            alert("Reportado."); cerrarModal();
        };

        window.abrirModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.cerrarModal = () => { document.getElementById('modalTramite').classList.add('hidden'); document.getElementById('modalSaldo').classList.add('hidden'); };
        window.cerrarSesion = () => signOut(auth).then(() => window.location.href = "login/index.html");
    </script>
</body>
</html>
