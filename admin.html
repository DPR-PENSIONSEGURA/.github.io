<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Maestro | DPR ConsultorÃ­a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .badge-asesor { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 900; }
        .badge-web { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 900; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-black uppercase italic text-slate-800 tracking-tighter">Panel <span class="text-blue-600">DPR Admin</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Control de TrÃ¡fico y Finanzas</p>
            </div>

            <div class="flex flex-wrap gap-4 w-full lg:w-auto">
                <div class="flex-1 lg:flex-none bg-orange-500 text-white p-5 rounded-[2rem] shadow-xl flex items-center gap-4 border-b-4 border-orange-700">
                    <span class="text-3xl">ðŸ”¥</span>
                    <div>
                        <p class="text-[9px] font-black uppercase opacity-70 mb-1">Visitas de Hoy</p>
                        <p id="txtVisitas" class="text-2xl font-black">0</p>
                    </div>
                </div>
                <div class="flex-1 lg:flex-none bg-emerald-600 text-white p-5 rounded-[2rem] shadow-xl flex items-center gap-4 border-b-4 border-emerald-800">
                    <span class="text-3xl">ðŸ’°</span>
                    <div>
                        <p class="text-[9px] font-black uppercase opacity-70 mb-1">Ganancia Hoy</p>
                        <p id="gananciaHoy" class="text-2xl font-black">$0.00</p>
                    </div>
                </div>
                <div class="flex-1 lg:flex-none bg-blue-600 text-white p-5 rounded-[2rem] shadow-xl flex items-center gap-4 border-b-4 border-blue-800">
                    <span class="text-3xl">ðŸ“‹</span>
                    <div>
                        <p class="text-[9px] font-black uppercase opacity-70 mb-1">Pendientes</p>
                        <p id="contadorPendientes" class="text-2xl font-black">0</p>
                    </div>
                </div>
            </div>
        </header>

        <section class="mb-12">
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100">
                <h2 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6">Rendimiento Semanal</h2>
                <div class="h-[250px] w-full"><canvas id="graficoSemanal"></canvas></div>
            </div>
        </section>

        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEDygVfkQbJgMuEmm_We-OlQFTKzQ1raM",
            authDomain: "pensionsegura-9c817.firebaseapp.com",
            projectId: "pensionsegura-9c817"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let idActual, miGrafico = null;
        window.solicitudesData = {};

        // 1. ESCUCHAR VISITAS DIARIAS (CORREGIDO)
        const hoyStr = new Date().toISOString().split('T')[0];
        onSnapshot(doc(db, "visitas_diarias", hoyStr), (docSnap) => {
            document.getElementById('txtVisitas').innerText = docSnap.exists() ? docSnap.data().contador : "0";
        });

        // 2. ESCUCHAR TRÃMITES, CORTE Y GRÃFICO
        onSnapshot(query(collection(db, "solicitudes"), orderBy("fecha", "desc")), (snap) => {
            const tabla = document.getElementById('tablaSolicitudes');
            const contadorP = document.getElementById('contadorPendientes');
            const txtGanancia = document.getElementById('gananciaHoy');
            
            let countP = 0, totalHoy = 0, hoyLocal = new Date().toLocaleDateString();
            const solicitudesGrafico = [];

            tabla.innerHTML = "";
            snap.forEach(d => {
                const item = d.data();
                window.solicitudesData[d.id] = item;
                solicitudesGrafico.push(item);

                if(item.estatus === 'En Proceso') countP++;
                if (item.fecha?.toDate().toLocaleDateString() === hoyLocal && item.estatus !== 'Error') {
                    totalHoy += Number(item.costo || 0);
                }

                // GeneraciÃ³n de filas de tabla (MantÃ©n tu lÃ³gica de htmlDocs igual aquÃ­)
                // ...
            });

            contadorP.innerText = countP;
            txtGanancia.innerText = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalHoy);
            actualizarGrafico(solicitudesGrafico);
        });

        function actualizarGrafico(solicitudes) {
            const ctx = document.getElementById('graficoSemanal').getContext('2d');
            const ultimos7Dias = [];
            const montosPorDia = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const fStr = d.toLocaleDateString();
                ultimos7Dias.push(fStr); montosPorDia[fStr] = 0;
            }
            solicitudes.forEach(s => {
                const fS = s.fecha?.toDate().toLocaleDateString();
                if (montosPorDia.hasOwnProperty(fS) && s.estatus !== 'Error') montosPorDia[fS] += Number(s.costo || 0);
            });
            if (miGrafico) miGrafico.destroy();
            miGrafico = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ultimos7Dias.map(f => f.split('/')[0] + ' Feb'),
                    datasets: [{
                        label: 'Ganancias',
                        data: ultimos7Dias.map(f => montosPorDia[f]),
                        borderColor: '#2563eb', fill: true, tension: 0.4, backgroundColor: 'rgba(37, 99, 235, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        
        // ... (Agrega tus funciones de aprobarRecarga, actualizarEstatus, filtrarTabla igual que antes)
    </script>
</body>
</html>
