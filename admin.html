<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPR Admin | Control Maestro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card-stat { transition: transform 0.3s ease; }
        .card-stat:hover { transform: translateY(-5px); }
        .badge { padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; text-transform: uppercase; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-black uppercase italic text-slate-800">Panel <span class="text-blue-600">DPR Admin</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Garc칤a, Nuevo Le칩n | Gesti칩n Estrat칠gica</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full lg:w-auto">
                <div class="card-stat bg-orange-500 text-white p-5 rounded-[2rem] shadow-xl flex items-center gap-4 border-b-4 border-orange-700">
                    <span class="text-3xl">游댠</span>
                    <div>
                        <p class="text-[9px] font-black uppercase opacity-70">Visitas de Hoy</p>
                        <p id="txtVisitas" class="text-2xl font-black">0</p>
                    </div>
                </div>
                <div class="card-stat bg-emerald-600 text-white p-5 rounded-[2rem] shadow-xl flex items-center gap-4 border-b-4 border-emerald-800">
                    <span class="text-3xl">游눯</span>
                    <div>
                        <p class="text-[9px] font-black uppercase opacity-70">Ganancia Hoy</p>
                        <p id="gananciaHoy" class="text-2xl font-black">$0.00</p>
                    </div>
                </div>
                <div class="card-stat bg-blue-600 text-white p-5 rounded-[2rem] shadow-xl flex items-center gap-4 border-b-4 border-blue-800">
                    <span class="text-3xl">游늶</span>
                    <div>
                        <p class="text-[9px] font-black uppercase opacity-70">Pendientes</p>
                        <p id="contadorPendientes" class="text-2xl font-black">0</p>
                    </div>
                </div>
            </div>
        </header>

        <section class="mb-12">
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100">
                <h2 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6">Rendimiento Semanal (Ingresos)</h2>
                <div class="h-[300px] w-full">
                    <canvas id="graficoSemanal"></canvas>
                </div>
            </div>
        </section>

        <section class="mb-12">
            <h2 class="text-xl font-black uppercase italic mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">Validaci칩n de Recargas</h2>
            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-slate-200">
                <table class="w-full text-left">
                    <thead class="bg-slate-900 text-white text-[10px] uppercase font-black">
                        <tr>
                            <th class="p-5">Asesor</th>
                            <th class="p-5">Monto</th>
                            <th class="p-5">Baucher</th>
                            <th class="p-5 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaRecargas"></tbody>
                </table>
            </div>
        </section>

        <section>
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-black uppercase italic text-slate-700 border-l-4 border-blue-600 pl-4">Gesti칩n de Tr치mites</h2>
                <input type="text" id="buscador" onkeyup="window.filtrarTabla()" placeholder="BUSCAR POR CURP O NOMBRE..." class="w-full md:w-80 p-3 rounded-2xl border border-slate-300 shadow-sm text-[10px] font-bold uppercase">
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900 sticky top-0 text-white text-[10px] uppercase font-black">
                            <tr>
                                <th class="p-4">Fecha</th>
                                <th class="p-4">Servicio</th>
                                <th class="p-4">Cliente / Info</th>
                                <th class="p-4 text-center">Estatus</th>
                                <th class="p-4 text-right">Resultado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaSolicitudes" class="text-xs font-medium"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <div id="modalSubir" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl">
            <h2 class="text-xl font-black mb-4 uppercase italic">Subir Resultado Final</h2>
            <p id="txtFolio" class="text-blue-600 font-bold mb-6"></p>
            <input type="file" id="inputArchivo" class="block w-full text-xs mb-6 border p-2 rounded-lg">
            <button id="btnGuardar" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase italic">Finalizar Tr치mite</button>
            <button onclick="window.cerrarModal()" class="mt-4 text-slate-400 font-bold text-[10px] uppercase">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, where, orderBy, doc, updateDoc, increment, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEDygVfkQbJgMuEmm_We-OlQFTKzQ1raM",
            authDomain: "pensionsegura-9c817.firebaseapp.com",
            projectId: "pensionsegura-9c817",
            storageBucket: "pensionsegura-9c817.firebasestorage.app"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const CLOUD_NAME = "de5abnhul"; 
        const UPLOAD_PRESET = "dpr_uploads";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;

        let miGrafico = null, idTramiteActual = "";
        window.solicitudesCache = {};

        // Funci칩n auxiliar para normalizar fechas y evitar errores de comparaci칩n
        const obtenerFechaSimple = (fecha) => {
            if (!fecha) return null;
            const d = fecha instanceof Date ? fecha : (fecha.toDate ? fecha.toDate() : new Date(fecha));
            return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        };

        // 1. ESCUCHAR VISITAS DE HOY
        const hoyISO = new Date().toISOString().split('T')[0];
        onSnapshot(doc(db, "visitas_diarias", hoyISO), (d) => {
            document.getElementById('txtVisitas').innerText = d.exists() ? d.data().contador : "0";
        });

        // 2. ESCUCHAR TR츼MITES Y GANANCIAS
        onSnapshot(query(collection(db, "solicitudes"), orderBy("fecha", "desc")), (snap) => {
            const tabla = document.getElementById('tablaSolicitudes');
            const txtGanancia = document.getElementById('gananciaHoy');
            const txtPendientes = document.getElementById('contadorPendientes');
            
            let totalHoy = 0, pendientes = 0;
            const hoyNormalizado = obtenerFechaSimple(new Date());
            const dataGrafico = {};

            tabla.innerHTML = "";
            snap.forEach(d => {
                const item = d.data();
                const id = d.id;
                window.solicitudesCache[id] = item;

                const fechaItem = item.fecha?.toDate().toLocaleDateString();
                const fechaNormalizada = obtenerFechaSimple(item.fecha);

                if(item.estatus === 'En Proceso') pendientes++;
                
                // Sumar si la fecha normalizada coincide y no es error
                if(fechaNormalizada === hoyNormalizado && item.estatus !== 'Error') {
                    totalHoy += Number(item.costo || 0);
                }

                // L칩gica Gr치fico
                if(item.estatus !== 'Error') {
                    dataGrafico[fechaItem] = (dataGrafico[fechaItem] || 0) + Number(item.costo || 0);
                }

                let docs = item.comprobante ? `<button onclick="window.open('${item.comprobante}')" class="bg-purple-600 text-white px-2 py-1 rounded text-[8px] font-bold mr-1">PAGO WEB</button>` : "";
                if(item.documentacion) {
                    Object.keys(item.documentacion).forEach(k => {
                        docs += `<button onclick="window.open('${item.documentacion[k]}')" class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[8px] font-bold border mr-1">游늯 ${k}</button>`;
                    });
                }

                tabla.innerHTML += `
                    <tr class="border-b hover:bg-blue-50 transition">
                        <td class="p-4 text-slate-400 font-bold">${fechaItem || '...'}</td>
                        <td class="p-4 font-black uppercase">${item.tipo}<div class="mt-1">${docs}</div></td>
                        <td class="p-4">
                            <div class="font-black text-slate-900 uppercase">${item.nombre}</div>
                            <div class="text-[9px] text-blue-500 font-bold">${item.curp} | NSS: ${item.nss || 'N/A'}</div>
                        </td>
                        <td class="p-4 text-center">
                            <select onchange="window.cambiarEstatus('${id}', this.value)" class="border rounded p-1 font-bold text-[10px]">
                                <option value="En Proceso" ${item.estatus === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                                <option value="Terminado" ${item.estatus === 'Terminado' ? 'selected' : ''}>Terminado</option>
                                <option value="Error" ${item.estatus === 'Error' ? 'selected' : ''}>Error</option>
                            </select>
                        </td>
                        <td class="p-4 text-right">
                            ${item.archivoFinal ? `<button onclick="window.open('${item.archivoFinal}')" class="bg-green-500 text-white px-3 py-1 rounded-lg font-black">VER</button>` : `<button onclick="window.abrirSubida('${id}', '${item.folio}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg font-black">SUBIR</button>`}
                        </td>
                    </tr>`;
            });

            txtPendientes.innerText = pendientes;
            txtGanancia.innerText = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalHoy);
            dibujarGrafico(dataGrafico);
        });

        // 3. VALIDAR RECARGAS Y SUMARLAS A INGRESOS
        onSnapshot(query(collection(db, "notificaciones_pago"), where("estatus", "==", "pendiente")), (snap) => {
            const t = document.getElementById('tablaRecargas');
            t.innerHTML = snap.empty ? '<tr><td colspan="4" class="p-10 text-center text-slate-300 font-bold uppercase text-[10px]">Sin recargas pendientes</td></tr>' : "";
            snap.forEach(d => {
                const r = d.data();
                t.innerHTML += `<tr class="border-b"><td class="p-5 font-bold text-slate-700">${r.asesorEmail}</td><td class="p-5 font-black text-green-600">$${r.monto}</td><td class="p-5"><button onclick="window.open('${r.comprobante}')" class="text-blue-600 underline font-bold">Ver Baucher</button></td><td class="p-5 text-center flex justify-center gap-2"><button onclick="window.validarRecarga('${d.id}', '${r.uid}', ${r.monto}, 'aprobado')" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-[9px]">APROBAR</button><button onclick="window.validarRecarga('${d.id}', '${r.uid}', ${r.monto}, 'rechazado')" class="bg-red-500 text-white px-4 py-2 rounded-xl font-black text-[9px]">RECHAZAR</button></td></tr>`;
            });
        });

        window.validarRecarga = async (docId, uid, monto, est) => {
            if(est === 'aprobado') {
                try {
                    await updateDoc(doc(db, "asesores", uid), { saldo: increment(Number(monto)) });
                    await updateDoc(doc(db, "notificaciones_pago", docId), { estatus: "aprobado" });
                    
                    // Crear registro en solicitudes para que sume a la ganancia de hoy
                    await addDoc(collection(db, "solicitudes"), {
                        tipo: "RECARGA SALDO",
                        costo: Number(monto),
                        fecha: Timestamp.now(),
                        nombre: "ABONO DE ASESOR",
                        curp: "SISTEMA",
                        estatus: "Terminado"
                    });
                    
                    alert("Saldo cargado e ingreso registrado correctamente.");
                } catch (e) { alert("Error al procesar: " + e.message); }
            } else {
                if(confirm("쮼liminar este reporte?")) await deleteDoc(doc(db, "notificaciones_pago", docId));
            }
        };

        // --- FUNCIONES DE APOYO ---

        function dibujarGrafico(datos) {
            const ctx = document.getElementById('graficoSemanal').getContext('2d');
            const labels = [], valores = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const f = d.toLocaleDateString();
                labels.push(f.split('/')[0] + ' Feb');
                valores.push(datos[f] || 0);
            }
            if (miGrafico) miGrafico.destroy();
            miGrafico = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Ingresos', data: valores, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.cambiarEstatus = async (id, est) => {
            if(est === 'Error') {
                const monto = prompt("Tr치mite con error. 쮺u치nto reembolsar al asesor?");
                if(monto) await updateDoc(doc(db, "asesores", window.solicitudesCache[id].asesor_uid), { saldo: increment(Number(monto)) });
            }
            await updateDoc(doc(db, "solicitudes", id), { estatus: est });
        };

        window.abrirSubida = (id, folio) => { idTramiteActual = id; document.getElementById('txtFolio').innerText = folio; document.getElementById('modalSubir').classList.remove('hidden'); };
        window.cerrarModal = () => document.getElementById('modalSubir').classList.add('hidden');

        document.getElementById('btnGuardar').onclick = async () => {
            const file = document.getElementById('inputArchivo').files[0];
            if(!file) return alert("Selecciona un archivo.");
            const btn = document.getElementById('btnGuardar');
            btn.innerText = "SUBIENDO..."; btn.disabled = true;
            const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
            const data = await res.json();
            await updateDoc(doc(db, "solicitudes", idTramiteActual), { archivoFinal: data.secure_url, estatus: "Terminado" });
            alert("춰Tr치mite finalizado!"); window.cerrarModal();
            btn.innerText = "Finalizar Tr치mite"; btn.disabled = false;
        };

        window.filtrarTabla = () => {
            const bus = document.getElementById('buscador').value.toUpperCase();
            const filas = document.getElementById('tablaSolicitudes').getElementsByTagName('tr');
            for(let f of filas) f.style.display = f.innerText.toUpperCase().includes(bus) ? "" : "none";
        };
    </script>
</body>
</html>
