<script>
    const SCRIPT_MAESTRO = "https://script.google.com/macros/s/AKfycbyMXYuuGGXaLPcYUDwJOje4KEdYR5HMQdt7FwzpjR0dam05lkH6_-IUdJ062tsd27pRIg/exec";

    async function enviarConComprobante(payload, fileInput, exitoId, folioId, wppLinkId) {
        if (!fileInput || fileInput.files.length === 0) {
            return alert("Por favor, adjunta tu comprobante de pago para procesar la solicitud.");
        }
        
        // Opcional: Cambiar el texto del botón a "Enviando..."
        const btnOriginalText = document.activeElement.innerText;
        const activeBtn = document.activeElement;
        activeBtn.innerText = "ENVIANDO...";
        activeBtn.disabled = true;

        const reader = new FileReader();
        const archivo = fileInput.files[0];
        reader.readAsDataURL(archivo);
        
        reader.onload = async () => {
            payload.archivo = reader.result;
            payload.archivoNombre = archivo.name;

            try {
                await fetch(SCRIPT_MAESTRO, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(payload) 
                });

                document.getElementById(exitoId).classList.remove("hidden");
                document.getElementById(folioId).innerText = payload.folio;
                
                const textoWpp = `Hola Diana, envié mi registro de ${payload.tipo || payload.accion} (Folio: ${payload.folio}). El comprobante ya está en el sistema.`;
                const linkWpp = document.getElementById(wppLinkId);
                if(linkWpp) linkWpp.href = `https://wa.me/528131983700?text=${encodeURIComponent(textoWpp)}`;
                
            } catch (error) {
                alert("Hubo un error al enviar. Por favor intenta de nuevo.");
            } finally {
                activeBtn.innerText = btnOriginalText;
                activeBtn.disabled = false;
            }
        };
    }

    // Análisis Detallado
    function enviarDetallado() {
        const payload = {
            tipo: "Detallado",
            nombre: document.getElementById("nombreD").value,
            curp: document.getElementById("curpD").value,
            nss: document.getElementById("nssD").value,
            nacimiento: document.getElementById("nacD").value,
            correo: document.getElementById("correoD") ? document.getElementById("correoD").value : "N/A",
            tel: document.getElementById("telD").value,
            folio: "D-" + Math.floor(1000 + Math.random() * 9000)
        };
        enviarConComprobante(payload, document.getElementById("archivoD"), "exitoD", "folioD_ver", "wpp_detallado_link");
    }

    // Análisis Rápido
    function enviarRapido() {
        const payload = {
            tipo: "AnalisisRapido",
            nombre: document.getElementById("nombreR").value,
            tel: document.getElementById("telR").value,
            curp: document.getElementById("curpR").value,
            nss: document.getElementById("nssR").value,
            folio: "R-" + Math.floor(1000 + Math.random() * 9000)
        };
        enviarConComprobante(payload, document.getElementById("archivoR"), "exitoR", "folioR_ver", "wpp_doc_link");
    }

    // Documentos $15
    function solicitarDocumento() {
        const payload = {
            accion: "GuardarDocumento",
            curp: document.getElementById("doc_curp").value.trim().toUpperCase(),
            tipoDoc: document.getElementById("doc_tipo").value,
            folio: "DOC-" + Math.floor(1000 + Math.random() * 9000)
        };
        enviarConComprobante(payload, document.getElementById("archivo_pago"), "exitoDoc", "folioDoc_ver", "wpp_doc_link");
    }

    // Modalidad 10
    function validarYEnviarM10() {
        const payload = {
            tipo: "M10",
            nombre: document.getElementById("m10_nombre").value,
            idOficial: document.getElementById("m10_id").value,
            tel: document.getElementById("m10_tel").value,
            salario: document.getElementById("m10_salario").value,
            domicilio: document.getElementById("m10_dom").value,
            folio: "M10-" + Math.floor(1000 + Math.random() * 9000)
        };
        enviarConComprobante(payload, document.getElementById("m10_comprobante"), "exitoM10", "folioM10_ver", "m10_link_wpp");
    }
</script>
