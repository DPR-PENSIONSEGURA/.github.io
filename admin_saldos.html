<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPR Admin | Control de Bóveda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        .admin-table-container { background: white; border-radius: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .btn-approve { background-color: #10B981; color: white; transition: all 0.3s; }
        .btn-approve:hover { background-color: #059669; transform: scale(1.05); }
        .btn-reject { background-color: #EF4444; color: white; transition: all 0.3s; }
        .btn-reject:hover { background-color: #DC2626; transform: scale(1.05); }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black uppercase tracking-tighter italic">Control de <span class="text-blue-600">Bóveda</span></h1>
                <p class="text-slate-400 font-bold text-xs uppercase tracking-widest">DPR Consultoría | Administración</p>
            </div>
            <div class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-100 text-center">
                <p class="text-[10px] font-black uppercase text-slate-400">Pendientes de Pago</p>
                <p id="countPendientes" class="text-xl font-black text-blue-600">0</p>
            </div>
        </header>

        <div class="admin-table-container overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest">
                    <tr>
                        <th class="p-6">Asesor</th>
                        <th class="p-6">Monto Solicitado</th>
                        <th class="p-6">Referencia / Rastreo</th>
                        <th class="p-6">Comprobante</th>
                        <th class="p-6 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaPendientes" class="divide-y divide-slate-100">
                    </tbody>
            </table>
            <div id="noData" class="hidden p-20 text-center text-slate-300 font-bold uppercase italic tracking-widest">
                No hay pagos pendientes por validar
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

       // Aquí pegaremos tus "llaves" de Firebase en el siguiente paso
const firebaseConfig = {
  apiKey: "AIzaSyA3btkCIzFYOs6EXIa0FaecuB1jTqGH3w4",
  authDomain: "pensionsegura-eeaff.firebaseapp.com",
  projectId: "pensionsegura-eeaff",
  storageBucket: "pensionsegura-eeaff.firebasestorage.app",
  messagingSenderId: "96463651258",
  appId: "1:96463651258:web:cb4cf865990d9521035d83",
  measurementId: "G-F18HTRZ4YH"
    };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ESCUCHAR PAGOS PENDIENTES
        const q = query(collection(db, "notificaciones_pago"), where("estatus", "==", "pendiente"));
        
        onSnapshot(q, (snapshot) => {
            const tabla = document.getElementById("tablaPendientes");
            const count = document.getElementById("countPendientes");
            const noData = document.getElementById("noData");
            
            tabla.innerHTML = "";
            count.innerText = snapshot.size;

            if (snapshot.empty) {
                noData.classList.remove('hidden');
            } else {
                noData.classList.add('hidden');
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;

                    tabla.innerHTML += `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-6">
                                <p class="font-black text-slate-800 uppercase text-sm">${data.asesorEmail.split('@')[0]}</p>
                                <p class="text-[10px] text-slate-400 font-bold">${data.asesorEmail}</p>
                            </td>
                            <td class="p-6">
                                <span class="text-lg font-black text-green-600">$${data.monto.toFixed(2)}</span>
                            </td>
                            <td class="p-6">
                                <span class="bg-slate-100 px-3 py-1 rounded-lg font-mono text-xs font-bold text-slate-600">${data.rastreo}</span>
                            </td>
                            <td class="p-6">
                                <a href="${data.comprobante}" target="_blank" class="group relative inline-block">
                                    <img src="${data.comprobante}" class="w-12 h-12 rounded-xl object-cover border-2 border-slate-200 group-hover:border-blue-500 transition">
                                    <span class="absolute inset-0 flex items-center justify-center bg-black/40 text-[8px] text-white opacity-0 group-hover:opacity-100 rounded-xl font-black">VER</span>
                                </a>
                            </td>
                            <td class="p-6 text-center space-x-2">
                                <button onclick="aprobarPago('${id}', '${data.uid}', ${data.monto})" class="btn-approve px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-green-100">Aprobar</button>
                                <button onclick="rechazarPago('${id}')" class="btn-reject px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-red-100">Rechazar</button>
                            </td>
                        </tr>
                    `;
                });
            }
        });

        // LÓGICA DE APROBACIÓN
        window.aprobarPago = async (docId, asesorUid, monto) => {
            if (!confirm(`¿Confirmas el depósito de $${monto} en la cuenta Banorte?`)) return;

            try {
                // 1. Actualizar el saldo del asesor (Suma atómica)
                const asesorRef = doc(db, "asesores", asesorUid);
                await updateDoc(asesorRef, {
                    saldo: increment(monto)
                });

                // 2. Marcar notificación como aprobada
                await updateDoc(doc(db, "notificaciones_pago", docId), {
                    estatus: "aprobado"
                });

                alert("Saldo abonado exitosamente al asesor.");
            } catch (e) {
                console.error(e);
                alert("Error al procesar el abono.");
            }
        };

        window.rechazarPago = async (docId) => {
            if (!confirm("¿Deseas rechazar esta notificación de pago?")) return;
            await updateDoc(doc(db, "notificaciones_pago", docId), {
                estatus: "rechazado"
            });
        };

    </script>
</body>
</html>
